{% extends 'layouts/base.html' %}
{% load i18n %}
{% load static %}

{% block title %}Исследования{% endblock title %}
{% block extrahead %}
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    {#    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"#}
    {#    integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">#}

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
            integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
            crossorigin="anonymous"></script>
    {#    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"#}
    {#        integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV"#}
    {#        crossorigin="anonymous"></script>#}
{% endblock extrahead %}
{% block extrastyle %}
    <style>
        .not-visible {
            display: none;
        }
    </style>
{% endblock extrastyle %}
{% block content %}

    <body class="bg-light bg-gradient">
    <div class="container">
        <div class="card col-lg-12 col-md-12">
            <div class="container form">
                {% if research_avail_count > 0 %}
                    <form id="upload_form" class="form" method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <h3 class="pt-5 pb-5">{% blocktrans %}Загрузить исследование{% endblocktrans %}</h3>

                        <label class="">{% blocktrans %}Загрузите ваше исследование из томографа Galileos в формате .zip
                            или
                            .rar{% endblocktrans %}</label>
                        {% if form.errors %}
                            <div class="col-12 justify-content-center">
                                <div class="alert alert-light alert-dismissible fade show animated animatedFadeInUp fadeInUp"
                                     role="alert">
                                    <span><b>{{ form.errors }}</b></span>
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"
                                            aria-label="Close"></button>
                                </div>
                            </div>
                        {% endif %}
                        <div id="file_input" class="form-control p-3">
                            {{ form.raw_archive }}
                        </div>

                        <div class="form-check form-switch pt-5">
                            {{ form.is_anonymous }}
                            <label class="form-check-label text-body ms-3 text-truncate w-80 mb-0"
                                   for="flexSwitchCheckDefault1">{% blocktrans %}Анонимизировать данные о
                                пациенте{% endblocktrans %}</label>
                        </div>

                        <div class="form-check form-switch pt-2">
                            {{ form.is_one_file }}
                            <label class="form-check-label text-body ms-3 text-truncate w-80 mb-0"
                                   for="flexSwitchCheckDefault2">{% blocktrans %}Сформировать одним
                                файлом{% endblocktrans %}</label>
                        </div>

                        <button id="submit_btn" type="submit"
                                class="col-lg-4 btn bg-gradient-info mt-3">{% trans "Подтвердить" %}</button>

                        <!-- Progress Bar start -->
                        <div class="container not-visible progress" id="progress"></div>
                        <!-- Progress Bar end -->

                    </form>
                {% else %}
                    <div class="card-header pb-0 px-3">
                        <h6 class="mb-0">{% blocktrans %}У вас нет доступных конвертаций{% endblocktrans %}</h6>
                    </div>
                    {% include 'includes/pricing.html' %}
                {% endif %}
                {% if research %}
                    <div class="container-fluid mt-5">
                        <h4>{% blocktrans %}Готовые исследования{% endblocktrans %}</h4>
                        <ol>
                            {% for r in research %}
                                <li><a class="" href="/media/{{ r.ready_archive }}">
                                    <p class="bg-gradient-faded-light rounded text-center text-dark text-bold mt-3">
                                        [ {{ r.date_created }} ] [ {{ r }} ] {% blocktrans %}Скачать
                                        архив{% endblocktrans %} <i class="fa fa-download"></i></p></a></li>
                            {% endfor %}
                        </ol>

                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    </body>

{% endblock content %}
{% block extrascript %}

    <script>
        const uploadForm = document.getElementById('upload_form');
        const input_file = document.getElementById('id_raw_archive');
        const progress_bar = document.getElementById('progress');

        $("#upload_form").submit(function (e) {
            e.preventDefault();
            $form = $(this)
            var formData = new FormData(this);
            const media_data = input_file.files[0];
            if (media_data != null) {
                console.log(media_data);
                progress_bar.classList.remove("not-visible");
            }

            $.ajax({
                type: 'POST',
                url: '/',
                data: formData,
                dataType: 'json',
                beforeSend: function () {

                },
                xhr: function () {
                    const xhr = new window.XMLHttpRequest();
                    xhr.upload.addEventListener('progress', e => {
                        if (e.lengthComputable) {
                            const percentProgress = (e.loaded / e.total) * 100;
                            console.log(percentProgress);
                            progress_bar.innerHTML = `<div class="progress-bar progress-bar-striped bg-success"
                    role="progressbar" style="width: ${percentProgress}%" aria-valuenow="${percentProgress}" aria-valuemin="0"
                    aria-valuemax="100"></div>`
                        }
                    });
                    return xhr
                },
                success: function (response) {
                    console.log(response);
                    uploadForm.reset()
                    progress_bar.classList.add('not-visible')
                },
                error: function (err) {
                    console.log(err);
                },
                cache: false,
                contentType: false,
                processData: false,
            });
        });

    </script>
{% endblock extrascript %}